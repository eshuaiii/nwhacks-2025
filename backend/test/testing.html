<!DOCTYPE html>
<html>

<head>
    <title>WebSocket Test</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>

<body>
    <h1>WebSocket Test</h1>
    <label for="role">Select Role:</label>
    <select id="role" onchange="toggleSendMessageButton()">
        <option value="client">Client</option>
        <option value="dispatcher">Dispatcher</option>
    </select>
    <div id="clientNameContainer" style="display: none;">
        <label for="clientName">Enter your name:</label>
        <input type="text" id="clientName" />
    </div>
    <button id="startSendingButton" onclick="startSendingLocation()">Start Sending Location</button>
    <button id="stopSendingButton" onclick="stopSendingLocation()" style="display: none;">Stop Sending Location</button>

    <div id="messages" style="margin-top: 20px;">
        <h2>Recent Messages</h2>
        <ul id="messagesList"></ul>
    </div>

    <script>
        const socket = io("http://127.0.0.1:3000");
        let sendLocationInterval;

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
        });

        socket.on('message_from_client', (data) => {
            console.log('Message from client:', data);
            const role = document.getElementById('role').value;
            if (role === 'dispatcher') {
                const messagesList = document.getElementById('messagesList');
                const messageItem = document.createElement('li');
                messageItem.textContent = `From ${data.sender}: ${data.message}`;
                messagesList.appendChild(messageItem);
            }
        });

        function sendMessage(position) {
            const role = document.getElementById('role').value;
            const clientName = document.getElementById('clientName').value || 'Anonymous';
            const message = `Latitude: ${position.coords.latitude}, Longitude: ${position.coords.longitude}`;
            socket.emit('message_to_dispatcher', { sender: clientName, message: message });
        }

        function toggleSendMessageButton() {
            const role = document.getElementById('role').value;
            const startSendingButton = document.getElementById('startSendingButton');
            const stopSendingButton = document.getElementById('stopSendingButton');
            const clientNameContainer = document.getElementById('clientNameContainer');
            if (role === 'dispatcher') {
                startSendingButton.style.display = 'none';
                stopSendingButton.style.display = 'none';
                clientNameContainer.style.display = 'none';
            } else {
                startSendingButton.style.display = 'block';
                stopSendingButton.style.display = sendLocationInterval ? 'block' : 'none';
                clientNameContainer.style.display = 'block';
            }
        }

        function sendLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(sendMessage);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function startSendingLocation() {
            sendLocation();
            sendLocationInterval = setInterval(sendLocation, 5000); // Send location every 5 seconds
            document.getElementById('stopSendingButton').style.display = 'block';
        }

        function stopSendingLocation() {
            clearInterval(sendLocationInterval);
            sendLocationInterval = null;
            document.getElementById('stopSendingButton').style.display = 'none';
        }

        // Initial check to set the button visibility on page load
        toggleSendMessageButton();
    </script>
</body>

</html>